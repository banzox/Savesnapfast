---
import Layout from "../layouts/Layout.astro";
import Downloader from "./Downloader.jsx";
import FAQ from "./FAQ.astro";
import AdBanner from "./AdBanner.astro";
import { getTranslations, useTranslations } from "../utils/i18n";

interface Props {
    lang: string;
    pagePrefix: string;
    mode?: "video" | "mp3" | "story" | "slideshow" | undefined;
    showAd?: boolean;
}

const { lang, pagePrefix, mode, showAd = true } = Astro.props;
const t = useTranslations(lang);
const translations = getTranslations(lang);

// --- Helper to build keys ---
const getKey = (suffix: string) =>
    pagePrefix ? `${pagePrefix}.${suffix}` : suffix;

// --- Smart FAQ Loop ---
const faqItems = [];
let i = 1;
while (true) {
    const qKey = getKey(`faq.q${i}`);
    const aKey = getKey(`faq.a${i}`);
    const q = t(qKey);
    const a = t(aKey);

    if (!q || q === qKey || !a || a === aKey) {
        break;
    }

    faqItems.push({ question: q, answer: a });
    i++;
}

// --- Dynamic Features Generation ---
const featureKeys = [
    "no_watermark",
    "fast",
    "quality",
    "device",
    "unlimited",
    "safe",
    "anonymous",
    "slides",
    "expire",
    "favorites",
    "trending",
    "ringtone",
    "bulk",
    "original",
    "format",
];
const features = [];

for (const key of featureKeys) {
    const titleKey = getKey(`features.${key}.title`);
    const descKey = getKey(`features.${key}.desc`);
    const title = t(titleKey);
    const desc = t(descKey);

    if (title && title !== titleKey) {
        let icon = "fas fa-star";
        if (key === "no_watermark") icon = "fas fa-magic";
        if (key === "fast") icon = "fas fa-bolt";
        if (key === "quality") icon = "fas fa-hd";
        if (key === "device") icon = "fas fa-mobile-alt";
        if (key === "unlimited") icon = "fas fa-infinity";
        if (key === "safe") icon = "fas fa-shield-alt";
        if (key === "anonymous") icon = "fas fa-user-secret";
        if (key === "slides") icon = "fas fa-layer-group";
        if (key === "expire") icon = "fas fa-clock";
        if (key === "favorites") icon = "fas fa-heart";
        if (key === "trending") icon = "fas fa-fire";
        if (key === "ringtone") icon = "fas fa-bell";
        if (key === "bulk") icon = "fas fa-images";
        if (key === "original") icon = "fas fa-check-circle";
        if (key === "format") icon = "fas fa-file-image";

        features.push({ icon, title, desc });
    }
}

// --- How-To Section ---
const howToSteps = [];
let s = 1;
while (true) {
    const titleKey = `how_to.step${s}_title`;
    const descKey = getKey(`how_to.step${s}`);
    const desc = t(descKey);

    if (!desc || desc === descKey) break;

    const stepTitle = t(titleKey) || `Step ${s}`;
    howToSteps.push({ title: stepTitle, desc });
    s++;
}

const showHowTo = howToSteps.length > 0;
const howToTitle = t(getKey("how_to.title"));

// --- About Section ---
const aboutTitleKey = getKey("about_title");
const aboutTitle = t(aboutTitleKey);
const aboutContent = t(getKey("about_content"));
const showAbout = aboutTitle && aboutTitle !== aboutTitleKey;
let aboutIcon = "fas fa-info-circle";
if (pagePrefix.includes("mp3")) aboutIcon = "fas fa-headphones";
if (pagePrefix.includes("story")) aboutIcon = "fas fa-photo-film";
if (pagePrefix.includes("slideshow")) aboutIcon = "fas fa-layer-group";

// --- Meta Data ---
// Smart fallback: Check if translated value is different from the key (means translation exists)
const pageMetaTitleKey = getKey("meta_title");
const pageMetaDescKey = getKey("meta_desc");
const pageMetaTitle = t(pageMetaTitleKey);
const pageMetaDesc = t(pageMetaDescKey);

// Only use page-specific meta if translation exists (value !== key)
const metaTitle =
    pageMetaTitle !== pageMetaTitleKey ? pageMetaTitle : t("meta.title");
const metaDesc =
    pageMetaDesc !== pageMetaDescKey ? pageMetaDesc : t("meta.description");

// --- Hero ---
let heroTitleDesc = "";
let heroDesc = "";
let heroOnColor = "";

if (!pagePrefix) {
    heroTitleDesc = t("hero.title");
    heroDesc = t("hero.desc");
    heroOnColor = t("downloader.hd_quality");
} else {
    heroTitleDesc = t(`${pagePrefix}.title`);
    heroDesc = t(`${pagePrefix}.desc`);
    if (pagePrefix === "mp3_page") heroOnColor = t(`${pagePrefix}.subtitle`);
}
---

<Layout title={metaTitle} description={metaDesc} lang={lang}>
    <div class="main-wrapper">
        <article class="hero-section">
            <h1 class="hero-title">
                {
                    pagePrefix === "mp3_page" ? (
                        <span>
                            <i class="fas fa-music accent-text" />{" "}
                            {heroTitleDesc}{" "}
                            <span class="accent-text">{heroOnColor}</span>
                        </span>
                    ) : pagePrefix === "story_page" ? (
                        <span>
                            <i class="fas fa-images accent-text" />{" "}
                            {heroTitleDesc}
                        </span>
                    ) : pagePrefix === "slideshow_page" ? (
                        <span>
                            <i class="fas fa-layer-group accent-text" />{" "}
                            {heroTitleDesc}
                        </span>
                    ) : (
                        <span>
                            {t("hero.title")}{" "}
                            <span class="accent-text">
                                ({t("downloader.hd_quality")})
                            </span>
                        </span>
                    )
                }
            </h1>
            <p class="hero-desc">
                {heroDesc}
            </p>

            <div class="downloader-wrapper">
                <Downloader
                    client:load
                    messages={translations.downloader}
                    mode={mode}
                    placeholder={pagePrefix
                        ? t(`${pagePrefix}.placeholder`)
                        : t("downloader.placeholder")}
                />
            </div>
        </article>
    </div>

    {showAd && <AdBanner />}

    <section class="container features-grid">
        {
            features.map((feature) => (
                <div class="feature-card">
                    <i class={feature.icon} />
                    <h3>{feature.title}</h3>
                    <p>{feature.desc}</p>
                </div>
            ))
        }
    </section>

    {
        showHowTo && (
            <section class="container how-to-box shadow-box">
                <h2 class="section-title">{howToTitle}</h2>
                <div class="steps-wrapper">
                    {howToSteps.map((step, index) => (
                        <div class="step">
                            <div class="step-num">{index + 1}</div>
                            <h3>{step.title}</h3>
                            <p>{step.desc}</p>
                        </div>
                    ))}
                </div>
            </section>
        )
    }

    {
        showAbout && (
            <section class="container shadow-box about-section">
                <div class="content-box">
                    <h2>
                        <i class={`${aboutIcon} accent-text`} /> {aboutTitle}
                    </h2>
                    <p>{aboutContent}</p>
                </div>
            </section>
        )
    }

    <FAQ t={t} items={faqItems} />
</Layout>

<style>
    /* Hero Section */
    .hero-section {
        text-align: center;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
    }

    .hero-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    @media (min-width: 768px) {
        .hero-title {
            font-size: 2.25rem;
        }
    }

    .hero-desc {
        font-size: 1rem;
        margin-bottom: 2rem;
        max-width: 42rem;
        margin-left: auto;
        margin-right: auto;
        opacity: 0.9;
    }

    @media (min-width: 768px) {
        .hero-desc {
            font-size: 1.125rem;
        }
    }

    .accent-text {
        color: var(--secondary);
    }

    .downloader-wrapper {
        width: 100%;
        max-width: 48rem;
        margin-left: auto;
        margin-right: auto;
    }

    /* How To Steps Grid */
    .steps-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }

    .step {
        background: rgba(255, 255, 255, 0.03); /* Card bg */
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 25px;
        position: relative;
        overflow: hidden;
        transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
    }

    :global([data-theme="light"]) .step {
        background: #ffffff;
        border-color: rgba(0, 0, 0, 0.08);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); /* Softer, broader shadow */
    }

    .step:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border-color: rgba(0, 242, 234, 0.3); /* Hover color */
    }

    .step-num {
        font-size: 3rem;
        font-weight: 800;
        color: rgba(255, 255, 255, 0.05); /* Architectural styling */
        position: absolute;
        top: 10px;
        right: 20px;
        line-height: 1;
        pointer-events: none;
    }

    :global([data-theme="light"]) .step-num {
        color: rgba(0, 0, 0, 0.03);
    }

    .step h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
    }

    .step p {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-dim);
        position: relative;
        z-index: 1;
    }

    .section-title {
        text-align: center;
        margin-bottom: 40px;
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(to right, #fff, #bbb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    :global([data-theme="light"]) .section-title {
        background: linear-gradient(to right, #333, #666);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .about-section {
        margin-top: 3rem;
        padding: 40px;
        background: var(--card-bg); /* Use global card var if available */
        border-radius: 20px;
    }
</style>
