---
// LanguageSelector.astro
import { languages } from '../i18n/ui';
import Icon from './Icon.astro';

const { pathname, search } = Astro.url; // نحصل على المسار + بيانات البحث (search)
const currentLang = Astro.currentLocale || 'en';

/**
 * دالة: getLocalizedPath
 * الوظيفة: بناء الرابط الجديد مع الحفاظ على الصفحة الحالية + البيانات الموجودة في الرابط
 */
function getLocalizedPath(targetLang: string) {
  // 1. تقسيم المسار لمعالجة اللغة
  const parts = pathname.split('/').filter(Boolean);

  // هل الجزء الأول هو لغة؟ نحذفه لنحصل على المسار النظيف
  if (parts.length > 0 && Object.keys(languages).includes(parts[0])) {
    parts.shift();
  }
  
  const cleanPath = parts.join('/');
  
  // 2. بناء المسار الأساسي الجديد
  let newPath = '';
  if (targetLang === 'en') {
    newPath = '/' + cleanPath;
  } else {
    newPath = '/' + targetLang + (cleanPath ? '/' + cleanPath : '');
  }

  // تنظيف الشرطات المزدوجة (//) إن وجدت
  newPath = newPath.replace(/\/+/g, '/');
  // إزالة الشرطة في النهاية إذا لم يكن الرابط هو الجذر فقط
  if (newPath.length > 1 && newPath.endsWith('/')) {
    newPath = newPath.slice(0, -1);
  }

  // 3. الخطوة الأهم: إعادة دمج "search" (علامة الاستفهام وما بعدها)
  // هذا يضمن عدم ضياع رابط الفيديو أو التبويب عند تغيير اللغة
  return newPath + search;
}
---

<div class="relative inline-block text-left dropdown-container">
  
  <button
    type="button"
    class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
    id="language-menu-button"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span class="flex items-center gap-2">
      <Icon name={currentLang} class="w-5 h-5" />
      {languages[currentLang] || 'English'}
      <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </span>
  </button>

  <div
    class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50 hidden"
    id="language-dropdown"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="language-menu-button"
  >
    <div class="py-1" role="none">
      {
        Object.entries(languages).map(([lang, label]) => (
          <a
            href={getLocalizedPath(lang)}
            class={`block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 ${currentLang === lang ? 'bg-gray-100 font-bold' : ''}`}
            role="menuitem"
          >
            <span class="flex items-center gap-2">
              <Icon name={lang} class="w-5 h-5" />
              {label}
            </span>
          </a>
        ))
      }
    </div>
  </div>
</div>

<script>
  // كود التفاعل (يعمل مع التنقلات العادية و Astro View Transitions)
  function initLanguageDropdown() {
    const button = document.getElementById('language-menu-button');
    const dropdown = document.getElementById('language-dropdown');

    if (button && dropdown) {
      // إزالة أي مستمعين سابقين لتجنب التكرار (استنساخ العقدة)
      const newButton = button.cloneNode(true);
      if (button.parentNode) {
        button.parentNode.replaceChild(newButton, button);
      }
      
      const activeBtn = document.getElementById('language-menu-button');
      if (!activeBtn) return;

      // فتح وإغلاق القائمة
      activeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isExpanded = activeBtn.getAttribute('aria-expanded') === 'true';
          activeBtn.setAttribute('aria-expanded', String(!isExpanded));
          dropdown.classList.toggle('hidden');
      });

      // الإغلاق عند النقر في الخارج
      document.addEventListener('click', (event) => {
        if (!activeBtn.contains(event.target as Node) && !dropdown.contains(event.target as Node)) {
          activeBtn.setAttribute('aria-expanded', 'false');
          dropdown.classList.add('hidden');
        }
      });
    }
  }

  // التشغيل الأولي
  document.addEventListener('DOMContentLoaded', initLanguageDropdown);
  
  // إعادة التشغيل عند التنقل بين الصفحات في Astro
  document.addEventListener('astro:page-load', initLanguageDropdown);
</script>
