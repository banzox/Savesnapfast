---
import { languages } from "../i18n/ui";
import { useTranslations } from "../utils/i18n";
const { lang = "en" } = Astro.props;
const t = useTranslations(lang);
const currentLangName =
    languages[lang as keyof typeof languages] || languages["en"];
---

<header id="main-header">
    <nav class="nav-container">
        <a href={`/${lang === "en" ? "" : lang}`} class="logo">
            <i class="fab fa-tiktok"></i>
            <span class="logo-text">SaveTikFast</span>
        </a>

        <!-- Hamburger Icon for Mobile -->
        <button class="hamburger" id="hamburger" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Navigation Links & Settings Container -->
        <div class="nav-links" id="nav-links">
            <nav class="nav-menu" aria-label="Download Types">
                <a
                    href={`/${lang === "en" ? "" : lang}`}
                    class={!Astro.url.pathname.includes("mp3") &&
                    !Astro.url.pathname.includes("story") &&
                    !Astro.url.pathname.includes("slideshow")
                        ? "active"
                        : ""}
                    title={t("hero.title")}
                >
                    <i class="fas fa-video"></i>
                    <span>{t("nav_menu.video")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "mp3" : lang + "/mp3"}`}
                    class={Astro.url.pathname.includes("mp3") ? "active" : ""}
                    title={t("mp3_page.meta_title")}
                >
                    <i class="fas fa-music"></i>
                    <span>{t("nav_menu.mp3")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "story" : lang + "/story"}`}
                    class={Astro.url.pathname.includes("story") ? "active" : ""}
                    title={t("story_page.meta_title")}
                >
                    <i class="fas fa-images"></i>
                    <span>{t("nav_menu.stories")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "slideshow" : lang + "/slideshow"}`}
                    class={Astro.url.pathname.includes("slideshow")
                        ? "active"
                        : ""}
                    title={t("slideshow_page.meta_title")}
                >
                    <i class="fas fa-layer-group"></i>
                    <span>{t("nav_menu.slideshow")}</span>
                </a>
            </nav>

            <!-- Language Selector (Simple Dropdown or Link) -->
            <div class="lang-select" tabindex="0">
                <div class="lang-selector">
                    <button
                        class="theme-toggle"
                        id="theme-btn"
                        aria-label="Toggle Theme"
                    >
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="dropdown-trigger" id="lang-btn">
                        <span
                            >{
                                languages[lang as keyof typeof languages] ||
                                    languages["en"]
                            }</span
                        >
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-options" id="lang-options">
                        {
                            Object.entries(languages).map(([code, name]) => (
                                <a
                                    href={code === "en" ? "/" : `/${code}`}
                                    class="option-item"
                                >
                                    {name}
                                </a>
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <script>
        const initMenu = () => {
            const hamburger = document.getElementById("hamburger");
            const navLinks = document.getElementById("nav-links");

            if (!hamburger || !navLinks) return;

            // Clean up old listener if it exists
            // @ts-ignore
            if (hamburger._clickListener) {
                // @ts-ignore
                hamburger.removeEventListener(
                    "click",
                    hamburger._clickListener,
                );
            }

            const toggleMenu = (e) => {
                e.preventDefault(); // Stop default action
                e.stopPropagation();

                const isActive = navLinks.classList.contains("active");

                if (isActive) {
                    navLinks.classList.remove("active");
                    hamburger.classList.remove("active");
                    document.body.style.overflow = "";
                } else {
                    navLinks.classList.add("active");
                    hamburger.classList.add("active");
                    document.body.style.overflow = "hidden";
                }
            };

            hamburger.addEventListener("click", toggleMenu);
            // @ts-ignore
            hamburger._clickListener = toggleMenu;

            // Close when clicking links
            const handleLinkClick = () => {
                navLinks.classList.remove("active");
                hamburger.classList.remove("active");
                document.body.style.overflow = "";
            };

            navLinks.querySelectorAll("a").forEach((link) => {
                link.onclick = handleLinkClick;
            });

            // Close when clicking outside
            const closeOnClickOutside = (e) => {
                if (
                    navLinks.classList.contains("active") &&
                    !navLinks.contains(e.target) &&
                    !hamburger.contains(e.target)
                ) {
                    navLinks.classList.remove("active");
                    hamburger.classList.remove("active");
                    document.body.style.overflow = "";
                }
            };

            // Remove previous document listener to prevent stacking
            // @ts-ignore
            if (document._menuCloseListener) {
                // @ts-ignore
                document.removeEventListener(
                    "click",
                    document._menuCloseListener,
                );
            }
            document.addEventListener("click", closeOnClickOutside);
            // @ts-ignore
            document._menuCloseListener = closeOnClickOutside;
        };

        const initLang = () => {
            const langBtn = document.getElementById("lang-btn");
            const langOptions = document.getElementById("lang-options");

            if (!langBtn || !langOptions) return;

            // @ts-ignore
            if (langBtn._clickListener) {
                // @ts-ignore
                langBtn.removeEventListener("click", langBtn._clickListener);
            }

            const toggleLang = (e) => {
                e.stopPropagation();
                langOptions.classList.toggle("show");
                langBtn.classList.toggle("active");
            };

            langBtn.addEventListener("click", toggleLang);
            // @ts-ignore
            langBtn._clickListener = toggleLang;

            const closeLang = (e) => {
                if (
                    !langBtn.contains(e.target) &&
                    !langOptions.contains(e.target)
                ) {
                    langOptions.classList.remove("show");
                    langBtn.classList.remove("active");
                }
            };

            // @ts-ignore
            if (document._langCloseListener) {
                // @ts-ignore
                document.removeEventListener(
                    "click",
                    document._langCloseListener,
                );
            }
            document.addEventListener("click", closeLang);
            // @ts-ignore
            document._langCloseListener = closeLang;
        };

        const initTheme = () => {
            const themeBtn = document.getElementById("theme-btn");
            if (!themeBtn) return;

            // @ts-ignore
            if (themeBtn._clickListener) {
                // @ts-ignore
                themeBtn.removeEventListener("click", themeBtn._clickListener);
            }

            const updateIcon = () => {
                const icon = themeBtn.querySelector("i");
                if (icon) {
                    const isDark =
                        !document.documentElement.hasAttribute("data-theme");
                    icon.className = isDark ? "fas fa-moon" : "fas fa-sun";
                }
            };

            updateIcon();

            const toggleTheme = () => {
                // @ts-ignore
                if (typeof window.handleToggleClick === "function") {
                    // @ts-ignore
                    window.handleToggleClick();
                    updateIcon();
                }
            };

            themeBtn.addEventListener("click", toggleTheme);
            // @ts-ignore
            themeBtn._clickListener = toggleTheme;
        };

        const initAll = () => {
            // CRITICAL: Always reset overflow to prevent freezing
            document.body.style.overflow = "";
            initMenu();
            initLang();
            initTheme();
        };

        // Run immediately
        initAll();

        // Run on Astro View Transitions
        document.addEventListener("astro:after-swap", initAll);
        document.addEventListener("astro:page-load", initAll);
    </script>

    <style>
        .dropdown-options.show {
            display: grid !important;
        }
    </style>
</header>
