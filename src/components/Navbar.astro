---
import { languages } from "../i18n/ui";
import { useTranslations } from "../utils/i18n";
const { lang = "en" } = Astro.props;
const t = useTranslations(lang);
const currentLangName =
    languages[lang as keyof typeof languages] || languages["en"];
---

<header id="main-header">
    <nav class="nav-container">
        <a href={`/${lang === "en" ? "" : lang}`} class="logo">
            <i class="fab fa-tiktok"></i>
            <span class="logo-text">SaveTikFast</span>
        </a>

        <!-- Hamburger Icon for Mobile -->
        <button class="hamburger" id="hamburger" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Navigation Links & Settings Container -->
        <div class="nav-links" id="nav-links">
            <nav class="nav-menu" aria-label="Download Types">
                <a
                    href={`/${lang === "en" ? "" : lang}`}
                    class={!Astro.url.pathname.includes("mp3") &&
                    !Astro.url.pathname.includes("story") &&
                    !Astro.url.pathname.includes("slideshow")
                        ? "active"
                        : ""}
                    title={t("hero.title")}
                >
                    <i class="fas fa-video"></i>
                    <span>{t("nav_menu.video")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "mp3" : lang + "/mp3"}`}
                    class={Astro.url.pathname.includes("mp3") ? "active" : ""}
                    title={t("mp3_page.meta_title")}
                >
                    <i class="fas fa-music"></i>
                    <span>{t("nav_menu.mp3")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "story" : lang + "/story"}`}
                    class={Astro.url.pathname.includes("story") ? "active" : ""}
                    title={t("story_page.meta_title")}
                >
                    <i class="fas fa-images"></i>
                    <span>{t("nav_menu.stories")}</span>
                </a>
                <a
                    href={`/${lang === "en" ? "slideshow" : lang + "/slideshow"}`}
                    class={Astro.url.pathname.includes("slideshow")
                        ? "active"
                        : ""}
                    title={t("slideshow_page.meta_title")}
                >
                    <i class="fas fa-layer-group"></i>
                    <span>{t("nav_menu.slideshow")}</span>
                </a>
            </nav>

            <!-- Language Selector (Simple Dropdown or Link) -->
            <div class="lang-select" tabindex="0">
                <div class="lang-selector">
                    <button
                        class="theme-toggle"
                        id="theme-btn"
                        aria-label="Toggle Theme"
                    >
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="dropdown-trigger" id="lang-btn">
                        <span
                            >{
                                languages[lang as keyof typeof languages] ||
                                    languages["en"]
                            }</span
                        >
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-options" id="lang-options">
                        {
                            Object.entries(languages).map(([code, name]) => (
                                <a
                                    href={code === "en" ? "/" : `/${code}`}
                                    class="option-item"
                                >
                                    {name}
                                </a>
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <script>
        const initMenu = () => {
            const hamburger = document.getElementById("hamburger");
            const navLinks = document.getElementById("nav-links");

            if (hamburger && navLinks) {
                // Remove old listeners to prevent duplicates if any
                const newHamburger = hamburger.cloneNode(true);
                hamburger.parentNode.replaceChild(newHamburger, hamburger);

                newHamburger.addEventListener("click", (e) => {
                    e.stopPropagation(); // Stop bubbling
                    newHamburger.classList.toggle("active");
                    navLinks.classList.toggle("active");
                });

                // Close menu when clicking outside
                const closeMenu = (e) => {
                    // @ts-ignore
                    if (
                        !navLinks.contains(e.target) &&
                        !newHamburger.contains(e.target)
                    ) {
                        newHamburger.classList.remove("active");
                        navLinks.classList.remove("active");
                    }
                };
                document.addEventListener("click", closeMenu);

                // Close when clicking a link
                navLinks.querySelectorAll("a").forEach((link) => {
                    link.addEventListener("click", () => {
                        newHamburger.classList.remove("active");
                        navLinks.classList.remove("active");
                    });
                });
            }
        };

        const initTheme = () => {
            const themeBtn = document.getElementById("theme-btn");
            if (themeBtn) {
                // Clone to clear listeners
                const newThemeBtn = themeBtn.cloneNode(true);
                themeBtn.parentNode.replaceChild(newThemeBtn, themeBtn);

                newThemeBtn.addEventListener("click", () => {
                    // @ts-ignore
                    if (typeof window.handleToggleClick === "function") {
                        // @ts-ignore
                        window.handleToggleClick();
                        // Update icon
                        const icon = newThemeBtn.querySelector("i");
                        if (icon) {
                            const isDark =
                                !document.documentElement.hasAttribute(
                                    "data-theme",
                                );
                            icon.className = isDark
                                ? "fas fa-moon"
                                : "fas fa-sun";
                        }
                    }
                });

                // Init Icon
                const icon = newThemeBtn.querySelector("i");
                if (icon) {
                    const isDark =
                        !document.documentElement.hasAttribute("data-theme");
                    icon.className = isDark ? "fas fa-moon" : "fas fa-sun";
                }
            }
        };

        const initLang = () => {
            const langBtn = document.getElementById("lang-btn");
            const langOptions = document.getElementById("lang-options");

            if (langBtn && langOptions) {
                const newLangBtn = langBtn.cloneNode(true);
                langBtn.parentNode.replaceChild(newLangBtn, langBtn);

                newLangBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    langOptions.classList.toggle("show");
                    newLangBtn.classList.toggle("active");
                });

                document.addEventListener("click", (e) => {
                    // @ts-ignore
                    if (
                        !newLangBtn.contains(e.target) &&
                        !langOptions.contains(e.target)
                    ) {
                        langOptions.classList.remove("show");
                        newLangBtn.classList.remove("active");
                    }
                });
            }
        };

        // Run on initial load
        initMenu();
        initTheme();
        initLang();

        // Run on Astro Page Swap
        document.addEventListener("astro:after-swap", () => {
            initMenu();
            initTheme();
            initLang();
        });

        // Also listen to page-load if using new ViewTransitions API
        document.addEventListener("astro:page-load", () => {
            initMenu();
            initTheme();
            initLang();
        });
    </script>

    <style>
        .dropdown-options.show {
            display: grid !important;
        }
    </style>
</header>
